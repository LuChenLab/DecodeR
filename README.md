# DecodeR: an R package for barcode demultiplexing of nanopore direct RNA sequencing

Direct RNA sequencing offers a more comprehensive and accurate characterization of RNA biology. However, the main limitations of high-throughput direct RNA sequencing are the RNA amounts and the high cost required for sequencing and the lack of efficient multiplexing methods. Here, we propose a robust and fast multiplexing machine learning pipeline, DecodeR, achieving 99.4% accuracy with 73.3% recovery in demultiplexing 24 samples in one nanopore flow cell. Our *DecodeR* provide a robust, efficient, and accurate solution that can offer basic and clinical research of RNA features in a cost-effective manner.

## About DecodeR

The raw current signals were extracted from fast5 files using R package [rhdf5](https://github.com/grimbough/rhdf5). We implemented the [smoother](https://CRAN.R-project.org/package=smoother) method for the raw current signals to reduce the noise. We extracted signals of the adapter and the barcode from the raw electrical signals according to the characteristic higher and more stable current change generated by poly(A) tails and the lower current signals of DNA molecules. Then the cpt.meanvar function in the R package [changepoint](https://CRAN.R-project.org/package=changepoint). was used to divide the current signals of each barcode into 100 segments and calculated the average current values of each segment as a feature vector for modeling.

A matrix of 100 columns generated from all barcodes was eventually used for model training. The R package [caret](https://CRAN.R-project.org/package=caret) was implemented to streamline the process to produce the predictive models based on the Random Forest and other classification models. To prevent overfitting, we applied the repeated K-fold cross-validation (10-fold, repeated 10 times) method for resampling. To increase the computational efficiency of model training, we employed a parallel processing framework supported by R package [doParallel](https://CRAN.R-project.org/package=doParallel). Because the read numbers of each barcode were different, we used downSample function from R package *caret* to randomly sample a data set so that all classified groups have the same frequency. Next, we used 70% of these reads as a training set and the rest of the reads were used as a test set. 

![image1](./inst/extdata/image1.png)

## Requirements

If you want to use DecodeR, you'd better install the following R packages firstly.

- [changepoint](https://github.com/rkillick/changepoint/) 
- [data.table](https://cran.r-project.org/web/packages/data.table/)
- [doParallel](https://CRAN.R-project.org/package=doParallel)
- [randomForest](https://cran.r-project.org/web/packages/randomForest/index.html)
- [rhdf5](https://www.bioconductor.org/packages/release/bioc/html/rhdf5.html)
- [smoother](https://rdrr.io/cran/smoother/man/smoother.html)
- [caret](https://CRAN.R-project.org/package=caret)

## Installation

You can install the released version of DecodeR from GitHub with:

```R
if (!require(remotes)) install.packaages("remotes")
remotes::install_github("ChaoTang-SCU/DecodeR") # about 1 minute
```

## Examples

```R
library(DecodeR)

# get example file from package
fast5file <- system.file("extdata/demo2_0.fast5", package = "DecodeR")

# load in the model, limited by file size only the 2 barcodes model were built into the package
data("Model_2barcodes")

# predict the barcode of example fast5 file
pred <- DecodeR(fast5 = fast5file, model = Model_2barcodes) # about 10 seconds

# histogram of predicted probability
hist(pred$Probability, xlab = "Probability", main = "Histogram of Probability")

# number of each barcode
table(pred$Barcode)
# RTA-33 RTA-35
#     39     19
# set cutoff for unclassified read
pred2 <- DecodeR(fast5 = fast5file, model = Model_2barcodes, cutoff = 0.8)
table(pred2$Barcode)
#      RTA-33       RTA-35 unclassified
#          37           19            2

# systems
sessionInfo()
# R version 4.1.0 (2021-05-18)
# Platform: x86_64-apple-darwin17.0 (64-bit)
# Running under: macOS Big Sur 10.16
# 
# Matrix products: default
# BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.dylib
# LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib
# 
# locale:
# [1] zh_CN.UTF-8/zh_CN.UTF-8/zh_CN.UTF-8/C/zh_CN.UTF-8/zh_CN.UTF-8
# 
# attached base packages:
# [1] stats     graphics  grDevices utils     datasets  methods   base
# 
# other attached packages:
# [1] DecodeR_0.1.0
# 
# loaded via a namespace (and not attached):
# [1] zoo_1.8-9          compiler_4.1.0     parallel_4.1.0     rhdf5_2.36.0
# [5] xts_0.12.1         curl_4.3.2         rhdf5filters_1.4.0 grid_4.1.0
# [9] data.table_1.14.0  changepoint_2.2.2  TTR_0.24.2         smoother_1.1
# [13] lattice_0.20-44    Rhdf5lib_1.14.2
```

## Models

Other pre-trainded  models for 2 to 24 barcodes can be downloaded from [here]( https://doi.org/10.6084/m9.figshare.22678729).

## Citing Poreplex

A pre-print is going to be uploaded soon.

## See Also

- [PorexploreR](https://github.com/Shians/PorexploreR) \- A user-friendly R package for exploring raw Nanopore sequencing signals.
- [DeePlexiCon](https://github.com/Psy-Fer/deeplexicon) - Signal-based demultiplexing of direct RNA sequencing reads using convolutional neural networks
- [Poreplex](https://github.com/hyeshik/poreplex) - Signal-level preprocessor for Oxford Nanopore direct RNA sequencing (DRS) data. 

